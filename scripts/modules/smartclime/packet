var codes = require("./codes").dictionary;
var firebaseModule = require('../../modules/firebase/firebaseClient');
var firebase = new firebaseModule.Firebase();
var utils = require("./utils") ;

function Packet(packet) {
  this.anomaly = false;
  //var length = packet.length;
  
  if (packet.substring(0,22) !== "7e0029000100a100004b90" ) {
    this.anomaly = true;
    this.anomalyMessage = "Every packet should begin with '7e0029000100a100004b90'. This one doesn't.";
  }

  this.hardwareId = packet.substring(22,26);
  //this.temperature = packet.substring(length-2, length);
  this.event = codes[packet.substring(26,28)];
  
  if (this.event === null || this.event === "Unknown") {
    this.anomaly = true;
    this.anomalyMessage = "This packet has an event type of '" + packet.substring(26,28) + "', which is null or Unknown.";
  }
}

Packet.prototype.device = function() {

  var record = firebase.queryData('devices', {
    orderBy: 'hardwareId',
    equalTo: this.hardwareId
  });
  
  if ( Object.keys(record).length === 0 ) {
    record = {
      hardwareId: this.hardwareId,
      isNew: true
    };
    var newRecord = firebase.postData('devices', record);
    this.key = newRecord.name;
  } else {
	this.key = Object.keys(record)[0];
    record = record[this.key];
  }
  this.record = record;
  return record;
};

Packet.prototype.updateDevice = function() {
  this.record.status = this.event;
  this.record.updatedAt = new Date();
  var endpoint = 'devices/' + this.key;
  firebase.putData(endpoint, this.record);
};
var firebaseModule = require('../../modules/firebase/firebaseClient');
var firebase = new firebaseModule.Firebase();

function Packet(packet) {
  this.packet = packet;
  this.anomaly = false;
  
  var lengthSubstring = packet.substring(0,6);
  var normalLength = lengthSubstring === "7e0028" || lengthSubstring === "7e0029";
  if ( !normalLength ) {
    this.anomaly = true;
    this.anomalyMessage = "Abnormal length.";
  }  
  
  var deviceSubstring = packet.substring(6,10);
  var CDMAdevice = deviceSubstring === "0000";
  var GSMdevice =  deviceSubstring === "0001";
  if ( !CDMAdevice && !GSMdevice ) {
    this.anomaly = true;
    this.anomalyMessage = "Unrecognized device.";
  }

  if (GSMdevice) {
    this.hardwareId = packet.substring(22,26);
    this.eventCode = packet.substring(26,28);   
  } else {
    this.hardwareId = packet.substring(20,26);
    this.eventCode = packet.substring(26,28);
  }
  
  var codes = require("./codes").dictionary;
  this.event = codes[this.eventCode]; 

  //if (this.event === null || this.event === undefined) {
  //  this.anomaly = true;
  //  this.anomalyMessage = "This packet has an event type of '" + this.eventCode + "', which is Unknown.";
  //}
  
  if (this.anomaly === false) {
    this.device();
  }
}

Packet.prototype.device = function() {

  var record = firebase.queryData('devices', {
    orderBy: 'hardwareId',
    equalTo: this.hardwareId
  });
  
  if ( Object.keys(record).length === 0 ) {
    record = {
      hardwareId: this.hardwareId,
      isNew: true,
      createdAt: new Date()
    };
    var newRecord = firebase.postData('devices', record);
    this.key = newRecord.name;
  } else {
	this.key = Object.keys(record)[0];
    record = record[this.key];
  }
  this.record = record;
  return record;
};

Packet.prototype.updateDevice = function() {
  this.record.status = this.event;
  this.record.updatedAt = new Date();
  var endpoint = 'devices/' + this.key;
  firebase.putData(endpoint, this.record);
};

Packet.prototype.recordKeen = function() {
  var time = require('../../modules/utils/time');
  var device = this.record;
  var duration = time.secondsAgo(device.updatedAt);
  var keenModule = require('../../modules/keenio/keenioclient');
  var keen = new keenModule.Keenio("5785561b383144258cf97520");
  keen.recordEvent({
    collection: "device",
    data: {
      device: device,
      event: device.status,
      duration: duration,
      deviceId: device.key,
      packet: this.packet
    }
  });
};